<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¼ªçª—å£å·¥å…· - é¢å‘å¯¹è±¡ç¤ºä¾‹</title>
  <style>
    /* åŸºç¡€æ ·å¼ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      background: white;
      border-radius: 16px;
      padding: 40px;
      max-width: 900px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      color: #333;
      margin-bottom: 10px;
      font-size: 28px;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 14px;
    }

    .section-title {
      color: #333;
      font-size: 16px;
      margin: 25px 0 15px;
      font-weight: 600;
    }

    .button-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      margin-bottom: 20px;
    }

    .demo-button {
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
      color: white;
    }

    .demo-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .demo-button:active {
      transform: translateY(0);
    }

    .btn-primary { background: #667eea; }
    .btn-success { background: #4CAF50; }
    .btn-warning { background: #FF9800; }
    .btn-danger { background: #F44336; }
    .btn-info { background: #2196F3; }

    /* èƒŒæ™¯é®ç½© */
    .fake-window-wrapper.modal::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(4px);
      animation: fadeIn 0.2s ease;
    }

    /* å¯¹è¯æ¡†æ ·å¼ */
    .dialog-box {
      position: relative;
      z-index: 1;
      background: white;
      border-radius: 12px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      max-width: 500px;
      width: 90%;
      overflow: hidden;
      animation: slideUp 0.25s ease;
    }

    .dialog-header {
      padding: 20px 24px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .dialog-icon {
      font-size: 24px;
    }

    .dialog-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
      flex: 1;
    }

    .dialog-close {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      font-size: 24px;
      color: #999;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .dialog-close:hover {
      background: #f0f0f0;
      color: #333;
    }

    .dialog-body {
      padding: 24px;
      color: #666;
      line-height: 1.6;
    }

    .dialog-footer {
      padding: 16px 24px;
      border-top: 1px solid #eee;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .dialog-btn {
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dialog-btn-cancel {
      background: #f0f0f0;
      color: #333;
    }

    .dialog-btn-cancel:hover {
      background: #e0e0e0;
    }

    .dialog-btn-confirm {
      background: #667eea;
      color: white;
    }

    .dialog-btn-confirm:hover {
      background: #5568d3;
    }

    /* å³é”®èœå•æ ·å¼ */
    .context-menu-content {
      background: white;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
      min-width: 180px;
      padding: 6px 0;
      animation: slideIn 0.15s ease;
    }

    .menu-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 16px;
      cursor: pointer;
      transition: background 0.15s;
      color: #333;
    }

    .menu-item:hover {
      background: #f0f0f0;
    }

    .menu-icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .menu-divider {
      height: 1px;
      background: #ddd;
      margin: 6px 0;
    }

    .menu-item.danger {
      color: #ff3b30;
    }

    .menu-item.danger:hover {
      background: rgba(255, 59, 48, 0.1);
    }

    /* å›¾ç‰‡é¢„è§ˆæ ·å¼ */
    .preview-content {
      position: relative;
      z-index: 1;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      max-width: 90vw;
      max-height: 90vh;
      animation: fadeIn 0.3s ease;
    }

    .preview-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 32px;
      height: 32px;
      border: none;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border-radius: 50%;
      font-size: 20px;
      cursor: pointer;
      z-index: 1;
      transition: all 0.2s;
    }

    .preview-close:hover {
      background: rgba(0, 0, 0, 0.7);
    }

    .preview-image {
      max-width: 100%;
      max-height: 80vh;
      display: block;
      border-radius: 8px;
    }

    /* è¡¨å•ç¼–è¾‘å™¨æ ·å¼ */
    .form-group {
      margin-bottom: 16px;
    }

    .form-label {
      display: block;
      margin-bottom: 8px;
      color: #333;
      font-weight: 500;
    }

    .form-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
      transition: border-color 0.2s;
    }

    .form-input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    /* åŠ è½½åŠ¨ç”» */
    .loading-content {
      position: relative;
      z-index: 1;
      background: white;
      border-radius: 12px;
      padding: 40px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #f0f0f0;
      border-top-color: #667eea;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      margin: 0 auto 16px;
    }

    .loading-text {
      color: #666;
      font-size: 14px;
    }

    /* åŠ¨ç”»å®šä¹‰ */
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* å“åº”å¼ */
    @media (max-width: 600px) {
      .container {
        padding: 20px;
      }

      .button-grid {
        grid-template-columns: 1fr;
      }

      .dialog-footer {
        flex-direction: column-reverse;
      }

      .dialog-btn {
        width: 100%;
      }
    }

    /* ä»£ç ç¤ºä¾‹æ ·å¼ */
    .code-example {
      background: #f5f5f5;
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      font-size: 13px;
      overflow-x: auto;
    }

    .code-example pre {
      margin: 0;
      color: #333;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸªŸ ä¼ªçª—å£å·¥å…· - é¢å‘å¯¹è±¡ç‰ˆ</h1>
    <p class="subtitle">åŸºäºä¸¥æ ¼ OOP è®¾è®¡çš„çª—å£ç®¡ç†ç³»ç»Ÿ v2.0</p>

    <div class="section-title">ğŸ“š æ ¸å¿ƒæ¦‚å¿µæ¼”ç¤º</div>
    <div class="button-grid">
      <button class="demo-button btn-primary" onclick="showOOPExample()">
        OOP åŸºç¡€ç”¨æ³•
      </button>
      <button class="demo-button btn-success" onclick="showFactoryExample()">
        å·¥å‚æ¨¡å¼
      </button>
      <button class="demo-button btn-info" onclick="showEventExample()">
        äº‹ä»¶ç³»ç»Ÿ
      </button>
      <button class="demo-button btn-warning" onclick="showInheritanceExample()">
        ç»§æ‰¿æ‰©å±•
      </button>
    </div>

    <div class="section-title">ğŸ¨ å±…ä¸­æ¨¡æ€çª—å£</div>
    <div class="button-grid">
      <button class="demo-button btn-primary" onclick="showConfirmDialog()">
        ç¡®è®¤å¯¹è¯æ¡†
      </button>
      <button class="demo-button btn-info" onclick="showAlertDialog()">
        æç¤ºå¯¹è¯æ¡†
      </button>
      <button class="demo-button btn-success" onclick="showFormDialog()">
        è¡¨å•ç¼–è¾‘å™¨
      </button>
      <button class="demo-button btn-warning" onclick="showImagePreview()">
        å›¾ç‰‡é¢„è§ˆ
      </button>
    </div>

    <div class="section-title">ğŸ“ è‡ªå®šä¹‰ä½ç½®çª—å£</div>
    <div class="button-grid">
      <button class="demo-button btn-info" onclick="showContextMenu(event)">
        å³é”®èœå•
      </button>
      <button class="demo-button btn-primary" onclick="showTooltip(event)">
        å·¥å…·æç¤º
      </button>
      <button class="demo-button btn-success" onclick="showDropdown(event)">
        ä¸‹æ‹‰èœå•
      </button>
    </div>

    <div class="section-title">ğŸ¯ è±¡é™æ¨¡å¼æµ‹è¯•</div>
    <div class="button-grid">
      <button class="demo-button btn-primary" onclick="testQuadrant(event, 1)">
        ä¸»è±¡é™1ï¼ˆå³ä¸Šï¼‰
      </button>
      <button class="demo-button btn-success" onclick="testQuadrant(event, 2)">
        ä¸»è±¡é™2ï¼ˆå·¦ä¸Šï¼‰
      </button>
      <button class="demo-button btn-warning" onclick="testQuadrant(event, 3)">
        ä¸»è±¡é™3ï¼ˆå·¦ä¸‹ï¼‰
      </button>
      <button class="demo-button btn-info" onclick="testQuadrant(event, 4)">
        ä¸»è±¡é™4ï¼ˆå³ä¸‹ï¼‰
      </button>
    </div>

    <div class="section-title">âš¡ ç‰¹æ®ŠåŠŸèƒ½</div>
    <div class="button-grid">
      <button class="demo-button btn-warning" onclick="showLoading()">
        åŠ è½½æç¤º
      </button>
      <button class="demo-button btn-primary" onclick="showMultiple()">
        å¤šçª—å£
      </button>
      <button class="demo-button btn-danger" onclick="hideAllWindows()">
        å…³é—­æ‰€æœ‰
      </button>
    </div>
  </div>

  <!-- ç¡®è®¤å¯¹è¯æ¡† -->
  <div id="confirm-dialog" class="fake-window-wrapper">
    <div class="dialog-box">
      <div class="dialog-header">
        <span class="dialog-icon">â“</span>
        <span class="dialog-title">ç¡®è®¤æ“ä½œ</span>
        <button class="dialog-close" onclick="windowInstances.confirm.hide()">Ã—</button>
      </div>
      <div class="dialog-body">
        <p>ç¡®å®šè¦æ‰§è¡Œè¿™ä¸ªæ“ä½œå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
      </div>
      <div class="dialog-footer">
        <button class="dialog-btn dialog-btn-cancel" onclick="windowInstances.confirm.hide()">
          å–æ¶ˆ
        </button>
        <button class="dialog-btn dialog-btn-confirm" onclick="handleConfirm()">
          ç¡®å®š
        </button>
      </div>
    </div>
  </div>

  <!-- æç¤ºå¯¹è¯æ¡† -->
  <div id="alert-dialog" class="fake-window-wrapper">
    <div class="dialog-box">
      <div class="dialog-header">
        <span class="dialog-icon">â„¹ï¸</span>
        <span class="dialog-title">æç¤º</span>
        <button class="dialog-close" onclick="windowInstances.alert.hide()">Ã—</button>
      </div>
      <div class="dialog-body">
        <p>è¿™æ˜¯ä¸€ä¸ªæç¤ºä¿¡æ¯å¯¹è¯æ¡†ã€‚</p>
      </div>
      <div class="dialog-footer">
        <button class="dialog-btn dialog-btn-confirm" onclick="windowInstances.alert.hide()">
          ç¡®å®š
        </button>
      </div>
    </div>
  </div>

  <!-- è¡¨å•ç¼–è¾‘å™¨ -->
  <div id="form-dialog" class="fake-window-wrapper">
    <div class="dialog-box">
      <div class="dialog-header">
        <span class="dialog-icon">âœï¸</span>
        <span class="dialog-title">ç¼–è¾‘ä¿¡æ¯</span>
        <button class="dialog-close" onclick="windowInstances.form.hide()">Ã—</button>
      </div>
      <div class="dialog-body">
        <div class="form-group">
          <label class="form-label">å§“å</label>
          <input type="text" class="form-input" id="form-name" placeholder="è¯·è¾“å…¥å§“å">
        </div>
        <div class="form-group">
          <label class="form-label">é‚®ç®±</label>
          <input type="email" class="form-input" id="form-email" placeholder="è¯·è¾“å…¥é‚®ç®±">
        </div>
      </div>
      <div class="dialog-footer">
        <button class="dialog-btn dialog-btn-cancel" onclick="windowInstances.form.hide()">
          å–æ¶ˆ
        </button>
        <button class="dialog-btn dialog-btn-confirm" onclick="handleFormSubmit()">
          ä¿å­˜
        </button>
      </div>
    </div>
  </div>

  <!-- å›¾ç‰‡é¢„è§ˆ -->
  <div id="image-preview" class="fake-window-wrapper">
    <div class="preview-content">
      <button class="preview-close" onclick="windowInstances.preview.hide()">Ã—</button>
      <img class="preview-image" src="https://picsum.photos/800/600" alt="é¢„è§ˆå›¾ç‰‡">
    </div>
  </div>

  <!-- å³é”®èœå• -->
  <div id="context-menu" class="fake-window-wrapper">
    <div class="context-menu-content">
      <div class="menu-item" onclick="handleMenuAction('edit')">
        <span class="menu-icon">âœï¸</span>
        <span>ç¼–è¾‘</span>
      </div>
      <div class="menu-item" onclick="handleMenuAction('copy')">
        <span class="menu-icon">ğŸ“‹</span>
        <span>å¤åˆ¶</span>
      </div>
      <div class="menu-item" onclick="handleMenuAction('rename')">
        <span class="menu-icon">ğŸ·ï¸</span>
        <span>é‡å‘½å</span>
      </div>
      <div class="menu-divider"></div>
      <div class="menu-item danger" onclick="handleMenuAction('delete')">
        <span class="menu-icon">ğŸ—‘ï¸</span>
        <span>åˆ é™¤</span>
      </div>
    </div>
  </div>

  <!-- åŠ è½½æç¤º -->
  <div id="loading" class="fake-window-wrapper">
    <div class="loading-content">
      <div class="spinner"></div>
      <div class="loading-text">åŠ è½½ä¸­ï¼Œè¯·ç¨å€™...</div>
    </div>
  </div>

  <script>
    // ============================================================================
    // FakeWindow ç±»ï¼ˆå†…è”å®Œæ•´ç‰ˆ - é¢å‘å¯¹è±¡æ¶æ„ï¼‰
    // ============================================================================

    // æ ·å¼æ³¨å…¥å™¨ - å•ä¾‹æ¨¡å¼
    class StyleInjector {
      static #instance = null;
      #injected = false;

      static getInstance() {
        if (!StyleInjector.#instance) {
          StyleInjector.#instance = new StyleInjector();
        }
        return StyleInjector.#instance;
      }

      inject() {
        if (this.#injected) return;
        // æ ·å¼å·²åœ¨ HTML ä¸­å®šä¹‰
        this.#injected = true;
      }
    }

    // äº‹ä»¶å‘å°„å™¨åŸºç±» - è§‚å¯Ÿè€…æ¨¡å¼
    class EventEmitter {
      #listeners = new Map();

      on(event, handler) {
        if (!this.#listeners.has(event)) {
          this.#listeners.set(event, new Set());
        }
        this.#listeners.get(event).add(handler);
        return this;
      }

      off(event, handler) {
        if (!this.#listeners.has(event)) return this;
        if (handler) {
          this.#listeners.get(event).delete(handler);
        } else {
          this.#listeners.delete(event);
        }
        return this;
      }

      emit(event, ...args) {
        if (!this.#listeners.has(event)) return this;
        this.#listeners.get(event).forEach(handler => {
          try {
            handler(...args);
          } catch (error) {
            console.error(`Error in event handler for "${event}":`, error);
          }
        });
        return this;
      }

      once(event, handler) {
        const onceHandler = (...args) => {
          handler(...args);
          this.off(event, onceHandler);
        };
        return this.on(event, onceHandler);
      }

      removeAllListeners() {
        this.#listeners.clear();
      }
    }

    // Z-Index ç®¡ç†å™¨
    class ZIndexManager {
      static #instance = null;
      #maxZIndex = 10000;

      static getInstance() {
        if (!ZIndexManager.#instance) {
          ZIndexManager.#instance = new ZIndexManager();
        }
        return ZIndexManager.#instance;
      }

      getNext() {
        return ++this.#maxZIndex;
      }
    }

    // çª—å£é…ç½®ç±»
    class WindowConfig {
      static #defaults = {
        mode: 'centered',
        modal: true,
        backdropClose: true,
        quadrantMode: false,
        primaryQuadrant: 4,
        minMargin: 10,
        zIndex: null,
        x: 0,
        y: 0
      };

      #config;

      constructor(options = {}) {
        this.#config = { ...WindowConfig.#defaults, ...options };
      }

      get(key) {
        return this.#config[key];
      }

      set(key, value) {
        this.#config[key] = value;
      }

      update(options) {
        Object.assign(this.#config, options);
      }

      getAll() {
        return { ...this.#config };
      }
    }

    // ä¸»çª—å£ç±»
    class FakeWindow extends EventEmitter {
      #element;
      #config;
      #visible = false;
      #domHandlers = {};
      #destroyed = false;

      constructor(element, options = {}) {
        super();
        if (!element) throw new Error('FakeWindow: element is required');
        this.#element = element;
        this.#config = new WindowConfig(options);
        this.#initialize();
      }

      #initialize() {
        this.#element.classList.add('fake-window-wrapper');
        this.#visible = this.#element.classList.contains('show');
      }

      get element() { return this.#element; }
      get visible() { return this.#visible; }
      get mode() { return this.#config.get('mode'); }
      set mode(value) { this.#config.set('mode', value); }
      get modal() { return this.#config.get('modal'); }
      set modal(value) { this.#config.set('modal', value); }
      get config() { return this.#config.getAll(); }

      showCentered() {
        this.#config.set('mode', 'centered');
        return this.show();
      }

      showAt(x, y, options = {}) {
        this.#config.update({ ...options, mode: 'positioned', x, y });
        return this.show();
      }

      show() {
        if (this.#visible) return this;
        this.emit('beforeShow', this.#element);
        this.#removeEventListeners();
        this.#applyDisplay();
        this.#visible = true;
        this.emit('show', this.#element);
        return this;
      }

      hide() {
        if (!this.#visible) return this;
        this.emit('beforeHide', this.#element);
        this.#element.classList.remove('show');
        this.#visible = false;
        this.#removeEventListeners();
        this.emit('hide', this.#element);
        return this;
      }

      toggle() {
        return this.#visible ? this.hide() : this.show();
      }

      bringToFront() {
        this.#element.style.zIndex = ZIndexManager.getInstance().getNext();
        return this;
      }

      #applyDisplay() {
        const mode = this.#config.get('mode');
        if (mode === 'centered') {
          this.#element.classList.add('centered');
          this.#element.classList.remove('positioned');
        } else {
          this.#element.classList.add('positioned');
          this.#element.classList.remove('centered');
        }

        if (this.#config.get('modal')) {
          this.#element.classList.add('modal');
        } else {
          this.#element.classList.remove('modal');
        }

        const customZIndex = this.#config.get('zIndex');
        this.#element.style.zIndex = customZIndex || ZIndexManager.getInstance().getNext();
        this.#element.classList.add('show');

        if (mode === 'positioned') {
          this.#applyPositioning();
        }

        this.#setupEventListeners();
      }

      #applyPositioning() {
        const contentElement = this.#element.firstElementChild;
        if (!contentElement) return;

        const x = this.#config.get('x');
        const y = this.#config.get('y');

        if (this.#config.get('quadrantMode')) {
          this.#positionByQuadrant(contentElement, x, y);
        } else {
          contentElement.style.left = `${x}px`;
          contentElement.style.top = `${y}px`;
        }
      }

      #positionByQuadrant(element, originX, originY) {
        element.style.left = `${originX}px`;
        element.style.top = `${originY}px`;

        requestAnimationFrame(() => {
          const rect = element.getBoundingClientRect();
          const viewportWidth = window.innerWidth;
          const viewportHeight = window.innerHeight;
          const minMargin = this.#config.get('minMargin');

          const hasRight = (originX + rect.width + minMargin) <= viewportWidth;
          const hasLeft = (originX - rect.width - minMargin) >= 0;
          const hasBottom = (originY + rect.height + minMargin) <= viewportHeight;
          const hasTop = (originY - rect.height - minMargin) >= 0;

          const position = this.#calculateQuadrantPosition(
            originX, originY, rect.width, rect.height,
            hasRight, hasLeft, hasBottom, hasTop
          );

          element.style.left = `${position.x}px`;
          element.style.top = `${position.y}px`;
        });
      }

      #calculateQuadrantPosition(originX, originY, width, height, hasRight, hasLeft, hasBottom, hasTop) {
        const primaryQuadrant = this.#config.get('primaryQuadrant');
        let finalX, finalY;

        switch (primaryQuadrant) {
          case 4:
            if (hasRight && hasBottom) { finalX = originX; finalY = originY; }
            else if (!hasRight && hasBottom) { finalX = originX - width; finalY = originY; }
            else if (hasRight && !hasBottom) { finalX = originX; finalY = originY - height; }
            else { finalX = originX - width; finalY = originY - height; }
            break;
          case 1:
            if (hasRight && hasTop) { finalX = originX; finalY = originY - height; }
            else if (!hasRight && hasTop) { finalX = originX - width; finalY = originY - height; }
            else if (hasRight && !hasTop) { finalX = originX; finalY = originY; }
            else { finalX = originX - width; finalY = originY; }
            break;
          case 2:
            if (hasLeft && hasTop) { finalX = originX - width; finalY = originY - height; }
            else if (hasLeft && !hasTop) { finalX = originX - width; finalY = originY; }
            else if (!hasLeft && hasTop) { finalX = originX; finalY = originY - height; }
            else { finalX = originX; finalY = originY; }
            break;
          case 3:
            if (hasLeft && hasBottom) { finalX = originX - width; finalY = originY; }
            else if (!hasLeft && hasBottom) { finalX = originX; finalY = originY; }
            else if (hasLeft && !hasBottom) { finalX = originX - width; finalY = originY - height; }
            else { finalX = originX; finalY = originY - height; }
            break;
          default:
            finalX = originX; finalY = originY;
        }

        return { x: finalX, y: finalY };
      }

      #setupEventListeners() {
        if (this.#config.get('backdropClose')) {
          if (this.#config.get('mode') === 'centered') {
            this.#setupBackdropClose();
          } else {
            this.#setupOutsideClick();
          }
        }
        this.#setupEscClose();
      }

      #setupBackdropClose() {
        const handler = (e) => {
          if (e.target === this.#element && this.#visible) {
            this.hide();
          }
        };
        this.#element.addEventListener('click', handler);
        this.#domHandlers.backdropClickHandler = handler;
      }

      #setupOutsideClick() {
        const handler = (e) => {
          const contentElement = this.#element.firstElementChild;
          if (contentElement && !contentElement.contains(e.target) && this.#visible) {
            this.hide();
          }
        };
        setTimeout(() => {
          document.addEventListener('click', handler);
          this.#domHandlers.outsideClickHandler = handler;
        }, 0);
      }

      #setupEscClose() {
        const handler = (e) => {
          if (e.key === 'Escape' && this.#visible) {
            this.hide();
          }
        };
        document.addEventListener('keydown', handler);
        this.#domHandlers.escKeyHandler = handler;
      }

      #removeEventListeners() {
        if (this.#domHandlers.backdropClickHandler) {
          this.#element.removeEventListener('click', this.#domHandlers.backdropClickHandler);
          delete this.#domHandlers.backdropClickHandler;
        }
        if (this.#domHandlers.outsideClickHandler) {
          document.removeEventListener('click', this.#domHandlers.outsideClickHandler);
          delete this.#domHandlers.outsideClickHandler;
        }
        if (this.#domHandlers.escKeyHandler) {
          document.removeEventListener('keydown', this.#domHandlers.escKeyHandler);
          delete this.#domHandlers.escKeyHandler;
        }
      }
    }

    // çª—å£å·¥å‚ - å·¥å‚æ¨¡å¼
    class WindowFactory {
      static #presets = {
        dialog: { mode: 'centered', modal: true, backdropClose: false },
        alert: { mode: 'centered', modal: true, backdropClose: true },
        contextMenu: { mode: 'positioned', modal: false, backdropClose: true, quadrantMode: true, primaryQuadrant: 4, minMargin: 10 },
        tooltip: { mode: 'positioned', modal: false, backdropClose: false, quadrantMode: true, primaryQuadrant: 1, minMargin: 8 },
        dropdown: { mode: 'positioned', modal: false, backdropClose: true, quadrantMode: true, primaryQuadrant: 4, minMargin: 5 },
        modal: { mode: 'centered', modal: true, backdropClose: true }
      };

      static create(element, preset, options = {}) {
        const presetConfig = WindowFactory.#presets[preset] || {};
        const config = { ...presetConfig, ...options };
        return new FakeWindow(element, config);
      }

      static createDialog(element, options = {}) {
        return WindowFactory.create(element, 'dialog', options);
      }

      static createAlert(element, options = {}) {
        return WindowFactory.create(element, 'alert', options);
      }

      static createContextMenu(element, options = {}) {
        return WindowFactory.create(element, 'contextMenu', options);
      }

      static createTooltip(element, options = {}) {
        return WindowFactory.create(element, 'tooltip', options);
      }

      static createDropdown(element, options = {}) {
        return WindowFactory.create(element, 'dropdown', options);
      }

      static createModal(element, options = {}) {
        return WindowFactory.create(element, 'modal', options);
      }
    }

    // ============================================================================
    // åˆ›å»ºçª—å£å®ä¾‹ - å±•ç¤ºé¢å‘å¯¹è±¡ç”¨æ³•
    // ============================================================================

    const windowInstances = {
      // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå¯¹è¯æ¡†
      confirm: WindowFactory.createDialog(document.getElementById('confirm-dialog')),
      
      // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºæç¤ºæ¡†
      alert: WindowFactory.createAlert(document.getElementById('alert-dialog')),
      
      // ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»ºè¡¨å•çª—å£
      form: new FakeWindow(document.getElementById('form-dialog'), {
        mode: 'centered',
        modal: true,
        backdropClose: false
      }),
      
      // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºé¢„è§ˆçª—å£
      preview: WindowFactory.createModal(document.getElementById('image-preview')),
      
      // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºå³é”®èœå•
      contextMenu: WindowFactory.createContextMenu(document.getElementById('context-menu')),
      
      // ä½¿ç”¨å·¥å‚æ¨¡å¼åˆ›å»ºåŠ è½½çª—å£
      loading: new FakeWindow(document.getElementById('loading'), {
        mode: 'centered',
        modal: true,
        backdropClose: false
      })
    };

    // ============================================================================
    // äº‹ä»¶ç›‘å¬ç¤ºä¾‹ - å±•ç¤ºè§‚å¯Ÿè€…æ¨¡å¼
    // ============================================================================

    // ä¸ºè¡¨å•çª—å£æ·»åŠ äº‹ä»¶ç›‘å¬
    windowInstances.form
      .on('show', () => {
        console.log('ğŸ“ è¡¨å•çª—å£å·²æ˜¾ç¤º');
        document.getElementById('form-name').focus();
      })
      .on('hide', () => {
        console.log('ğŸ“ è¡¨å•çª—å£å·²éšè—');
      });

    // ä¸ºç¡®è®¤å¯¹è¯æ¡†æ·»åŠ äº‹ä»¶ç›‘å¬
    windowInstances.confirm
      .on('beforeShow', () => console.log('â³ ç¡®è®¤å¯¹è¯æ¡†å³å°†æ˜¾ç¤º'))
      .on('show', () => console.log('âœ… ç¡®è®¤å¯¹è¯æ¡†å·²æ˜¾ç¤º'))
      .on('beforeHide', () => console.log('â³ ç¡®è®¤å¯¹è¯æ¡†å³å°†éšè—'))
      .on('hide', () => console.log('âœ… ç¡®è®¤å¯¹è¯æ¡†å·²éšè—'));

    // ============================================================================
    // ç¤ºä¾‹å‡½æ•°
    // ============================================================================

    function showOOPExample() {
      alert('OOP åŸºç¡€ç”¨æ³•ç¤ºä¾‹ï¼š\n\n' +
        '// 1. ä½¿ç”¨æ„é€ å‡½æ•°åˆ›å»º\n' +
        'const window = new FakeWindow(element, { mode: "centered" });\n\n' +
        '// 2. ä½¿ç”¨ getter/setter\n' +
        'window.modal = true;\n' +
        'console.log(window.visible);\n\n' +
        '// 3. é“¾å¼è°ƒç”¨\n' +
        'window.show().bringToFront();\n\n' +
        '// 4. äº‹ä»¶ç›‘å¬\n' +
        'window.on("show", () => console.log("æ˜¾ç¤º"));\n\n' +
        'æŸ¥çœ‹æ§åˆ¶å°äº†è§£æ›´å¤šï¼'
      );
    }

    function showFactoryExample() {
      alert('å·¥å‚æ¨¡å¼ç¤ºä¾‹ï¼š\n\n' +
        '// ä½¿ç”¨å·¥å‚æ–¹æ³•åˆ›å»ºé¢„è®¾çª—å£\n' +
        'const dialog = WindowFactory.createDialog(element);\n' +
        'const menu = WindowFactory.createContextMenu(element);\n' +
        'const tooltip = WindowFactory.createTooltip(element);\n\n' +
        '// è‡ªå®šä¹‰é¢„è®¾\n' +
        'const custom = WindowFactory.create(element, "dialog", {\n' +
        '  backdropClose: true\n' +
        '});\n\n' +
        'æŸ¥çœ‹æ§åˆ¶å°äº†è§£æ›´å¤šï¼'
      );
    }

    function showEventExample() {
      // åˆ›å»ºä¸´æ—¶çª—å£æ¼”ç¤ºäº‹ä»¶
      const tempWindow = windowInstances.alert;
      
      // æ·»åŠ ä¸€æ¬¡æ€§äº‹ä»¶ç›‘å¬
      tempWindow.once('show', () => {
        console.log('ğŸ‰ è¿™ä¸ªäº‹ä»¶åªä¼šè§¦å‘ä¸€æ¬¡ï¼');
      });
      
      // æ˜¾ç¤ºçª—å£
      tempWindow.show();
      
      alert('äº‹ä»¶ç³»ç»Ÿç¤ºä¾‹ï¼š\n\n' +
        '// æ³¨å†Œäº‹ä»¶ç›‘å¬å™¨\n' +
        'window.on("show", handler);\n' +
        'window.on("hide", handler);\n\n' +
        '// ä¸€æ¬¡æ€§äº‹ä»¶\n' +
        'window.once("show", handler);\n\n' +
        '// ç§»é™¤ç›‘å¬å™¨\n' +
        'window.off("show", handler);\n\n' +
        '// ç”Ÿå‘½å‘¨æœŸé’©å­\n' +
        'window.on("beforeShow", handler);\n' +
        'window.on("afterHide", handler);\n\n' +
        'æŸ¥çœ‹æ§åˆ¶å°æŸ¥çœ‹äº‹ä»¶è§¦å‘ï¼'
      );
    }

    function showInheritanceExample() {
      alert('ç»§æ‰¿æ‰©å±•ç¤ºä¾‹ï¼š\n\n' +
        '// è‡ªå®šä¹‰çª—å£ç±»\n' +
        'class CustomWindow extends FakeWindow {\n' +
        '  constructor(element, options) {\n' +
        '    super(element, options);\n' +
        '  }\n\n' +
        '  // é‡å†™æ–¹æ³•\n' +
        '  show() {\n' +
        '    console.log("è‡ªå®šä¹‰æ˜¾ç¤ºé€»è¾‘");\n' +
        '    return super.show();\n' +
        '  }\n\n' +
        '  // æ·»åŠ æ–°æ–¹æ³•\n' +
        '  customMethod() {\n' +
        '    // è‡ªå®šä¹‰åŠŸèƒ½\n' +
        '  }\n' +
        '}\n\n' +
        '// ä½¿ç”¨è‡ªå®šä¹‰ç±»\n' +
        'const custom = new CustomWindow(element);\n\n' +
        'æŸ¥çœ‹æ–‡æ¡£äº†è§£æ›´å¤šæ‰©å±•æ–¹å¼ï¼'
      );
    }

    function showConfirmDialog() {
      windowInstances.confirm.showCentered();
    }

    function showAlertDialog() {
      windowInstances.alert.showCentered();
    }

    function showFormDialog() {
      document.getElementById('form-name').value = '';
      document.getElementById('form-email').value = '';
      windowInstances.form.showCentered();
    }

    function showImagePreview() {
      windowInstances.preview.showCentered();
    }

    function showContextMenu(event) {
      event.preventDefault();
      windowInstances.contextMenu.showAt(event.clientX, event.clientY);
    }

    function showTooltip(event) {
      alert('å·¥å…·æç¤ºåŠŸèƒ½æ¼”ç¤º\n\nå¯ä»¥ä½¿ç”¨ WindowFactory.createTooltip() åˆ›å»º');
    }

    function showDropdown(event) {
      showContextMenu(event);
    }

    function showLoading() {
      windowInstances.loading.showCentered();
      setTimeout(() => {
        windowInstances.loading.hide();
        showAlertDialog();
      }, 2000);
    }

    function showMultiple() {
      windowInstances.alert.showCentered();
      setTimeout(() => {
        windowInstances.confirm.showCentered();
      }, 300);
    }

    function hideAllWindows() {
      Object.values(windowInstances).forEach(w => w.hide());
    }

    function handleConfirm() {
      console.log('âœ… å·²ç¡®è®¤');
      windowInstances.confirm.hide();
    }

    function handleFormSubmit() {
      const name = document.getElementById('form-name').value;
      const email = document.getElementById('form-email').value;
      console.log('ğŸ’¾ ä¿å­˜æ•°æ®:', { name, email });
      windowInstances.form.hide();
    }

    function handleMenuAction(action) {
      console.log('ğŸ“‹ èœå•æ“ä½œ:', action);
      windowInstances.contextMenu.hide();
    }

    function testQuadrant(event, quadrant) {
      const quadrantNames = {
        1: 'å³ä¸Š',
        2: 'å·¦ä¸Š',
        3: 'å·¦ä¸‹',
        4: 'å³ä¸‹'
      };
      
      console.log(`ğŸ¯ æµ‹è¯•ä¸»è±¡é™ ${quadrant}ï¼ˆ${quadrantNames[quadrant]}ï¼‰`);
      
      // æ›´æ–°é…ç½®
      windowInstances.contextMenu.updateConfig({ primaryQuadrant: quadrant });
      windowInstances.contextMenu.showAt(event.clientX, event.clientY);
    }

    // æ¬¢è¿æ¶ˆæ¯
    console.log('ğŸ‰ ä¼ªçª—å£å·¥å…· v2.0 - é¢å‘å¯¹è±¡ç‰ˆ');
    console.log('ğŸ“š æ ¸å¿ƒç‰¹æ€§ï¼š');
    console.log('  - ä¸¥æ ¼çš„ OOP è®¾è®¡');
    console.log('  - äº‹ä»¶ç³»ç»Ÿï¼ˆè§‚å¯Ÿè€…æ¨¡å¼ï¼‰');
    console.log('  - å·¥å‚æ¨¡å¼');
    console.log('  - ç§æœ‰å­—æ®µå°è£…');
    console.log('  - Getter/Setter');
    console.log('  - é“¾å¼è°ƒç”¨');
    console.log('  - å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸé’©å­');
    
    setTimeout(() => {
      showAlertDialog();
    }, 500);
  </script>
</body>
</html>
# 时间回溯树文档

本文档提供时间回溯树的概述。

## 时间回溯树概述

时间回溯树 (aka. Undo Tree, hit)，是用来保存历史记录的树状结构。也传统的用栈等纯属结构保存的历史记录不同，Undo Tree 支持回溯到之前已被撤消过的分支。

## 术语定义

### 根节点 (root point, root)

一棵树只有一个根节点。相应的，hit 的根节点应是创建白板。

### 当前点 (current point, curr)

当前点白板当前状态下的最后执行的那一个分子操作在树上的节点。

### 后继点 (next point, next)

后继点是某节点的子节点中，最后一个曾成为过当前点的节点。

### 焦点链 (focus chain)

焦点链是从根节点开始，一直到当前点，再到当前点的后继，后继的后继，一直到叶子节点的链。

### 矮树 (short tree)

矮树是指树高小于等于 5 的树。

### 尝试 (attempt)

尝试指频繁的操作撤回，操作尝试不超过 5 次，而每次撤回的最终原点都是同一个的一系列操作。

在 hit 中，尝试就是那些不包含焦点链上的点的矮树。这棵矮树被称为尝试子树。

### 尝试节点 (attempt node)

以同一个节点为父节点的尝试的树根会被先连到尝试节点上，再经由尝试节点来连到它们原来的父节点。

### 可收的节点 (attemptable node)

当该节点能向下连接一个尝试节点时称其为可收的节点。

### 收树 (make attempt)

收树是将尝试提取出来，连到尝试节点中的过程

### 关键点 (very important point, vip)

关键点是一系列由用户或系统打了标签的点。

### 关键点树 (vip tree)

关键点树是主树的一棵包含所有关键点和当前点的最小生成树。

## 操作逻辑

### 收树逻辑

对于某节点，判断它是否要收树，即是否为可收的节点，应：

1. 将其子节点分为两类
	- 第一类子节点: 该子节点是尝试子树的根，且该子树内没有关键点。
	- 第二类子节点: 排除可收的节点的第一类子节点后，剩下的就是可收的节点的第二类子节点。
2. 当且仅当它有多个子节点，且有第一类子节点，它才是可收的节点。
3. 依前序遍历以判断整棵树的每个节点是否是可收的。

#### 收树时机

当焦点链发生变化，即当前点离开焦点链时，我们会重新判断某部分可收性可能会被改变的节点的可收性。

有些节点从不可收的变为可收的，就会执行收树操作。

有的节点尝试节点中的子节点可能会有增减。

有些节点从可收的变为不可收的，就会执行展开操作。展开操作是收树操作的逆操作。

### 关键点操作

#### 创建 vip

欲创建 vip，只需给该节点打上 vip 标记，然后让用户指定一个名称，再将其放入 vip tree 即可。

##### 在 attempt 中创建

在 attempt 中创建 vip 时，应先提取包含该 vip 的矮树 (见[矮树提取](#矮树提取))，然后在新增了 vip 的那个树链上收树。再之后就与上文无异了。

#### 删除关键点

欲删除 vip，需先删去 vip 标记、名称和颜色，再将其移出 vip tree，最后在删除了 vip 的那个树链上收树即可。

## 存储结构

我们将一棵 Undo Tree 分为多块。块有两类，一类是树块，一类是尝试块

### 树块 (tree block)

树块内有一棵树。

这棵树的根节点要么是 Undo Tree 的根节点，要么是某可收节点的第二类子节点。

这棵树的叶子节点要么是整棵树的叶子节点，要么是一个可收节点。

### 尝试块 (attempt blcok)

尝试块内有一棵树或是一片森林。

每棵树的根节点在 Undo Tree 中的父节点都是同一个可收的节点。这些节点都是该节点的第一类子节点。

每棵树在叶子节点在 Undo Tree 中也是叶子节点。

## 内存结构

## UI 规范

### 节点菜单

#### 节点信息

节点信息菜单包括了如下信息
- 节点名称
- 节点的“谓语”，即其执行的操作
- 节点的“宾语”，即其涉及到的对象

#### 节点颜色

与 git 一样，hit 的各节点链也是有颜色的。同时，用户可以自己设定关键点的颜色。

#### 节点注释

#### 删除分支

#### 移动至此

## hit 与协作

每一个人都有一棵自己的树，同时场上还有一棵公共树。

对每一个节点，都会记录其 author，如果 author 不是自己，就不能编辑该节点，只能移动至此。

## hit 与 ham

暂不考虑。